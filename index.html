<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Payment Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #F8FAFC; 
            color: #1E293B;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Entrance Animations */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Today Pulse Effect */
        @keyframes pulse-soft {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .today-marker {
            position: relative;
            animation: pulse-soft 2s infinite;
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #CBD5E1; }

        /* Calendar Cell Styling */
        .calendar-cell { 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (min-width: 768px) {
            .calendar-cell { min-height: 120px; }
            .calendar-cell:hover { 
                background: #FFFFFF !important;
                z-index: 10;
                transform: translateY(-2px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            }
        }
        @media (max-width: 767px) {
            .calendar-cell { min-height: 75px; }
        }

        .calendar-cell.selected-day { 
            background-color: #F0F9FF !important; 
            box-shadow: inset 0 0 0 2px #3B82F6 !important; 
        }

        /* Glass Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Filter Toggle Styling */
        .filter-btn { transition: all 0.2s ease; }
        .filter-btn.active { transform: scale(1.05); }
        .filter-btn.inactive { opacity: 0.5; grayscale: 1; background: #F1F5F9; border-color: #E2E8F0; color: #64748B; }

        /* Optical Centering for circles */
        .dot-align {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="p-3 md:p-8">

    <div class="max-w-6xl mx-auto space-y-6">
        
        <!-- Header Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Balance Card -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200/60 relative overflow-hidden group hover:shadow-md transition-shadow">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-50 rounded-full opacity-50 group-hover:scale-110 transition-transform"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="p-2 bg-emerald-100 text-emerald-600 rounded-xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Remaining</span>
                    </div>
                    <h2 id="dash-total-balance" class="text-3xl font-bold text-slate-800 tracking-tight">...</h2>
                    <p class="text-[11px] text-slate-400 mt-2">Future payments from <span id="current-date-display" class="font-semibold text-slate-500">today</span></p>
                </div>
            </div>

            <!-- Month Card -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200/60 relative overflow-hidden group hover:shadow-md transition-shadow">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-blue-50 rounded-full opacity-50 group-hover:scale-110 transition-transform"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="p-2 bg-blue-100 text-blue-600 rounded-xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Due in <span id="dash-month-name">...</span></span>
                    </div>
                    <h2 id="dash-month-total" class="text-3xl font-bold text-slate-800 tracking-tight">...</h2>
                    <p class="text-[11px] text-slate-400 mt-2">Active filter summary</p>
                </div>
            </div>

            <!-- Next Due Card -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200/60 relative overflow-hidden group hover:shadow-md transition-shadow">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-purple-50 rounded-full opacity-50 group-hover:scale-110 transition-transform"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="p-2 bg-purple-100 text-purple-600 rounded-xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Next Payment</span>
                    </div>
                    <h2 id="dash-next-amount" class="text-3xl font-bold text-purple-600 tracking-tight">...</h2>
                    <p id="dash-next-date" class="text-[11px] font-semibold text-purple-400 mt-2 uppercase">...</p>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-slate-200 p-3 md:p-4 sticky top-4 z-40">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4 w-full lg:w-auto">
                    <div class="flex items-center bg-slate-100 p-1 rounded-xl">
                        <button id="prev-month" class="p-2 hover:bg-white text-slate-500 rounded-lg transition-all active:scale-90">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <button id="jump-today" class="px-4 py-1.5 text-xs font-bold text-slate-600 hover:text-slate-900 transition-colors uppercase tracking-widest">Today</button>
                        <button id="next-month" class="p-2 hover:bg-white text-slate-500 rounded-lg transition-all active:scale-90">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <h2 id="month-year" class="text-xl font-bold text-slate-800 min-w-[180px] text-center"></h2>
                </div>

                <div class="flex flex-wrap justify-center lg:justify-end gap-2" id="filter-container">
                    <!-- Dynamic Filters -->
                </div>
            </div>
        </div>

        <!-- Calendar Container -->
        <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden animate-in">
            <div class="grid grid-cols-7 md:grid-cols-8 border-b border-slate-100 bg-slate-50/50">
                <div class="py-4 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sun</div>
                <div class="py-4 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mon</div>
                <div class="py-4 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tue</div>
                <div class="py-4 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">Wed</div>
                <div class="py-4 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">Thu</div>
                <div class="py-4 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">Fri</div>
                <div class="py-4 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sat</div>
                <div class="hidden md:flex items-center justify-center py-4 bg-emerald-50/50 border-l border-slate-100 text-[10px] font-bold text-emerald-600 uppercase tracking-widest">Weekly Total</div>
            </div>
            
            <div class="overflow-x-auto custom-scroll">
                <div id="calendar-grid" class="grid grid-cols-7 md:grid-cols-8 min-w-full bg-slate-100/50 gap-px">
                    <!-- JS Content -->
                </div>
            </div>
        </div>

        <!-- Detail Drawer -->
        <div id="day-details-container" class="hidden animate-in bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden">
            <div class="flex justify-between items-center px-6 py-5 border-b border-slate-100 bg-slate-50/50">
                <div class="flex flex-col">
                    <h3 class="font-bold text-slate-800 text-lg" id="detail-date-title">...</h3>
                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Payment Breakdown</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter">Day Total</span>
                    <span class="text-xl font-bold text-slate-900" id="detail-total">$0.00</span>
                </div>
            </div>
            <div id="detail-list" class="p-4 space-y-3">
                <!-- List Items -->
            </div>
        </div>
        
    </div>

    <script>
        // --- Core Data ---
        const colorPalettes = {
            '22239': { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-700', hover: 'hover:bg-emerald-100', dot: 'bg-emerald-500' },
            '22716': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', hover: 'hover:bg-blue-100', dot: 'bg-blue-500' },
            '22475': { bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-700', hover: 'hover:bg-indigo-100', dot: 'bg-indigo-500' },
            '22996': { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-800', hover: 'hover:bg-amber-100', dot: 'bg-amber-500' },
            '23792': { bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-700', hover: 'hover:bg-rose-100', dot: 'bg-rose-500' },
            '23989': { bg: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-700', hover: 'hover:bg-cyan-100', dot: 'bg-cyan-500' },
            'default': { bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-700', hover: 'hover:bg-gray-100', dot: 'bg-gray-500' }
        };

        const rawPayments = [
            { date: '2025-01-14', amount: 812.00, ref: '22239' }, { date: '2025-01-21', amount: 812.00, ref: '22239' },
            { date: '2025-01-28', amount: 812.00, ref: '22239' }, { date: '2025-02-04', amount: 812.00, ref: '22239' },
            { date: '2025-02-11', amount: 812.00, ref: '22239' }, { date: '2025-02-18', amount: 812.00, ref: '22239' },
            { date: '2025-02-25', amount: 812.00, ref: '22239' }, { date: '2025-03-04', amount: 812.00, ref: '22239' },
            { date: '2025-03-11', amount: 812.00, ref: '22239' }, { date: '2025-03-18', amount: 812.00, ref: '22239' },
            { date: '2025-03-25', amount: 812.00, ref: '22239' }, { date: '2025-04-01', amount: 812.00, ref: '22239' },
            { date: '2025-04-08', amount: 810.35, ref: '22239' }, { date: '2025-03-03', amount: 647.54, ref: '22716' },
            { date: '2025-03-10', amount: 647.54, ref: '22716' }, { date: '2025-03-17', amount: 647.54, ref: '22716' },
            { date: '2025-03-24', amount: 647.54, ref: '22716' }, { date: '2025-03-31', amount: 647.54, ref: '22716' },
            { date: '2025-04-07', amount: 647.54, ref: '22716' }, { date: '2025-04-14', amount: 647.54, ref: '22716' },
            { date: '2025-04-22', amount: 647.54, ref: '22716' }, { date: '2025-04-28', amount: 647.54, ref: '22716' },
            { date: '2025-05-05', amount: 647.54, ref: '22716' }, { date: '2025-05-12', amount: 647.54, ref: '22716' },
            { date: '2025-05-20', amount: 647.54, ref: '22716' }, { date: '2025-05-26', amount: 647.54, ref: '22716' },
            { date: '2025-06-02', amount: 647.54, ref: '22716' }, { date: '2025-06-09', amount: 647.54, ref: '22716' },
            { date: '2025-06-16', amount: 647.54, ref: '22716' }, { date: '2025-06-23', amount: 647.54, ref: '22716' },
            { date: '2025-06-30', amount: 647.54, ref: '22716' }, { date: '2025-07-07', amount: 647.54, ref: '22716' },
            { date: '2025-07-14', amount: 647.54, ref: '22716' }, { date: '2025-07-21', amount: 647.54, ref: '22716' },
            { date: '2025-07-28', amount: 647.54, ref: '22716' }, { date: '2025-08-05', amount: 647.54, ref: '22716' },
            { date: '2025-08-11', amount: 647.54, ref: '22716' }, { date: '2025-08-18', amount: 647.54, ref: '22716' },
            { date: '2025-08-25', amount: 644.28, ref: '22716' }, { date: '2025-02-05', amount: 817.31, ref: '22475' },
            { date: '2025-02-12', amount: 817.31, ref: '22475' }, { date: '2025-02-19', amount: 817.31, ref: '22475' },
            { date: '2025-02-26', amount: 817.31, ref: '22475' }, { date: '2025-03-05', amount: 817.31, ref: '22475' },
            { date: '2025-03-12', amount: 817.31, ref: '22475' }, { date: '2025-03-19', amount: 817.31, ref: '22475' },
            { date: '2025-03-26', amount: 817.31, ref: '22475' }, { date: '2025-04-02', amount: 817.31, ref: '22475' },
            { date: '2025-04-09', amount: 817.31, ref: '22475' }, { date: '2025-04-16', amount: 817.31, ref: '22475' },
            { date: '2025-04-23', amount: 817.31, ref: '22475' }, { date: '2025-04-30', amount: 815.58, ref: '22475' },
            { date: '2025-04-02', amount: 596.77, ref: '22996' }, { date: '2025-04-09', amount: 596.77, ref: '22996' },
            { date: '2025-04-16', amount: 596.77, ref: '22996' }, { date: '2025-04-23', amount: 596.77, ref: '22996' },
            { date: '2025-04-30', amount: 596.77, ref: '22996' }, { date: '2025-05-07', amount: 596.77, ref: '22996' },
            { date: '2025-05-14', amount: 596.77, ref: '22996' }, { date: '2025-05-21', amount: 596.77, ref: '22996' },
            { date: '2025-05-28', amount: 596.77, ref: '22996' }, { date: '2025-06-04', amount: 596.77, ref: '22996' },
            { date: '2025-06-11', amount: 596.77, ref: '22996' }, { date: '2025-06-18', amount: 596.77, ref: '22996' },
            { date: '2025-06-25', amount: 596.77, ref: '22996' }, { date: '2025-07-02', amount: 596.77, ref: '22996' },
            { date: '2025-07-09', amount: 596.77, ref: '22996' }, { date: '2025-07-16', amount: 596.77, ref: '22996' },
            { date: '2025-07-23', amount: 596.77, ref: '22996' }, { date: '2025-07-30', amount: 596.77, ref: '22996' },
            { date: '2025-08-06', amount: 596.77, ref: '22996' }, { date: '2025-08-13', amount: 596.77, ref: '22996' },
            { date: '2025-08-20', amount: 596.77, ref: '22996' }, { date: '2025-08-27', amount: 596.77, ref: '22996' },
            { date: '2025-09-03', amount: 596.77, ref: '22996' }, { date: '2025-09-10', amount: 596.77, ref: '22996' },
            { date: '2025-09-17', amount: 596.77, ref: '22996' }, { date: '2025-09-24', amount: 596.77, ref: '22996' },
            { date: '2025-10-01', amount: 596.77, ref: '22996' }, { date: '2025-10-08', amount: 596.77, ref: '22996' },
            { date: '2025-10-15', amount: 596.77, ref: '22996' }, { date: '2025-10-22', amount: 596.77, ref: '22996' },
            { date: '2025-10-29', amount: 596.77, ref: '22996' }, { date: '2025-11-05', amount: 596.77, ref: '22996' },
            { date: '2025-11-12', amount: 596.77, ref: '22996' }, { date: '2025-11-19', amount: 596.77, ref: '22996' },
            { date: '2025-11-26', amount: 596.77, ref: '22996' }, { date: '2025-12-03', amount: 596.77, ref: '22996' },
            { date: '2025-12-10', amount: 596.77, ref: '22996' }, { date: '2025-12-17', amount: 596.77, ref: '22996' },
            { date: '2025-12-24', amount: 585.93, ref: '22996' }, { date: '2025-07-11', amount: 303.80, ref: '23792' },
            { date: '2025-07-18', amount: 303.80, ref: '23792' }, { date: '2025-07-25', amount: 303.80, ref: '23792' },
            { date: '2025-08-01', amount: 303.80, ref: '23792' }, { date: '2025-08-08', amount: 303.80, ref: '23792' },
            { date: '2025-08-15', amount: 303.80, ref: '23792' }, { date: '2025-08-22', amount: 303.80, ref: '23792' },
            { date: '2025-08-29', amount: 303.80, ref: '23792' }, { date: '2025-09-05', amount: 303.80, ref: '23792' },
            { date: '2025-09-12', amount: 303.80, ref: '23792' }, { date: '2025-09-19', amount: 303.80, ref: '23792' },
            { date: '2025-09-26', amount: 303.80, ref: '23792' }, { date: '2025-10-03', amount: 303.80, ref: '23792' },
            { date: '2025-10-10', amount: 303.80, ref: '23792' }, { date: '2025-10-17', amount: 303.80, ref: '23792' },
            { date: '2025-10-24', amount: 303.80, ref: '23792' }, { date: '2025-10-31', amount: 303.80, ref: '23792' },
            { date: '2025-11-07', amount: 303.80, ref: '23792' }, { date: '2025-11-14', amount: 303.80, ref: '23792' },
            { date: '2025-11-21', amount: 303.80, ref: '23792' }, { date: '2025-11-28', amount: 303.80, ref: '23792' },
            { date: '2025-12-05', amount: 303.80, ref: '23792' }, { date: '2025-12-12', amount: 303.80, ref: '23792' },
            { date: '2025-12-19', amount: 303.80, ref: '23792' }, { date: '2025-12-29', amount: 303.80, ref: '23792' },
            { date: '2026-01-05', amount: 303.80, ref: '23792' }, { date: '2026-01-09', amount: 303.80, ref: '23792' },
            { date: '2026-01-16', amount: 303.80, ref: '23792' }, { date: '2026-01-23', amount: 303.80, ref: '23792' },
            { date: '2026-01-30', amount: 303.80, ref: '23792' }, { date: '2026-02-06', amount: 303.80, ref: '23792' },
            { date: '2026-02-13', amount: 303.80, ref: '23792' }, { date: '2026-02-20', amount: 303.80, ref: '23792' },
            { date: '2026-02-27', amount: 303.80, ref: '23792' }, { date: '2026-03-06', amount: 303.80, ref: '23792' },
            { date: '2026-03-13', amount: 303.80, ref: '23792' }, { date: '2026-03-20', amount: 303.80, ref: '23792' },
            { date: '2026-03-27', amount: 303.80, ref: '23792' }, { date: '2026-04-07', amount: 301.31, ref: '23792' },
            { date: '2025-08-05', amount: 1158.78, ref: '23989' }, { date: '2025-08-11', amount: 1158.78, ref: '23989' },
            { date: '2025-08-18', amount: 1158.78, ref: '23989' }, { date: '2025-08-25', amount: 1158.78, ref: '23989' },
            { date: '2025-09-02', amount: 1158.78, ref: '23989' }, { date: '2025-09-08', amount: 1158.78, ref: '23989' },
            { date: '2025-09-15', amount: 1158.78, ref: '23989' }, { date: '2025-09-22', amount: 1158.78, ref: '23989' },
            { date: '2025-09-29', amount: 1158.78, ref: '23989' }, { date: '2025-10-06', amount: 1.59, ref: '23989' },
        ];

        // --- State ---
        const todayActual = new Date();
        todayActual.setHours(0, 0, 0, 0);
        
        const state = {
            currentYear: todayActual.getFullYear(),
            currentMonth: todayActual.getMonth(),
            selectedDate: todayActual,
            activeFilters: new Set(Object.keys(colorPalettes).filter(k => k !== 'default'))
        };

        // --- Elements ---
        const els = {
            grid: document.getElementById('calendar-grid'),
            monthTitle: document.getElementById('month-year'),
            dashTotal: document.getElementById('dash-total-balance'),
            dashDate: document.getElementById('current-date-display'),
            dashMonthTotal: document.getElementById('dash-month-total'),
            dashMonthName: document.getElementById('dash-month-name'),
            dashNextAmt: document.getElementById('dash-next-amount'),
            dashNextDate: document.getElementById('dash-next-date'),
            filterContainer: document.getElementById('filter-container'),
            detailContainer: document.getElementById('day-details-container'),
            detailTitle: document.getElementById('detail-date-title'),
            detailTotal: document.getElementById('detail-total'),
            detailList: document.getElementById('detail-list')
        };

        // --- Utils ---
        const formatCurrency = (amt) => amt.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        const formatCompact = (amt) => amt >= 1000 ? '$' + (amt / 1000).toFixed(1) + 'k' : '$' + Math.round(amt);
        const getStyle = (ref) => colorPalettes[ref] || colorPalettes['default'];

        // --- Logic ---
        function initFilters() {
            els.filterContainer.innerHTML = '';
            const uniqueRefs = [...new Set(rawPayments.map(p => p.ref))].sort();
            uniqueRefs.forEach(ref => {
                const btn = document.createElement('button');
                const style = getStyle(ref);
                const isActive = state.activeFilters.has(ref);
                btn.className = `filter-btn text-[10px] md:text-xs px-4 py-2 rounded-full border font-bold flex items-center gap-2 ${isActive ? 'active' : 'inactive'}`;
                if (isActive) btn.classList.add(style.bg, style.border, style.text);
                btn.innerHTML = `<span class="w-2 h-2 rounded-full ${style.dot} shadow-sm"></span> Ref ${ref}`;
                btn.onclick = () => {
                    isActive ? state.activeFilters.delete(ref) : state.activeFilters.add(ref);
                    initFilters(); updateDashboard(); renderCalendar(); updateDetailView();
                };
                els.filterContainer.appendChild(btn);
            });
        }

        function getFilteredPayments() {
            return rawPayments.filter(p => state.activeFilters.has(p.ref));
        }

        function updateDashboard() {
            const activePayments = getFilteredPayments();
            let totalRemaining = 0, nextPayment = null, minDiff = Infinity;
            activePayments.forEach(p => {
                const [y, m, d] = p.date.split('-').map(Number);
                const pDate = new Date(y, m - 1, d);
                pDate.setHours(0,0,0,0);
                if (pDate >= todayActual) {
                    totalRemaining += p.amount;
                    const diff = pDate - todayActual;
                    if (diff < minDiff) { minDiff = diff; nextPayment = { ...p, jsDate: pDate }; }
                }
            });
            let monthTotal = 0;
            activePayments.forEach(p => {
                const [y, m, d] = p.date.split('-').map(Number);
                if (y === state.currentYear && (m-1) === state.currentMonth) monthTotal += p.amount;
            });
            els.dashTotal.textContent = formatCurrency(totalRemaining);
            if(els.dashDate) els.dashDate.textContent = todayActual.toLocaleDateString('en-CA');
            els.dashMonthTotal.textContent = formatCurrency(monthTotal);
            els.dashMonthName.textContent = new Date(state.currentYear, state.currentMonth).toLocaleString('default', { month: 'short' });
            if (nextPayment) {
                els.dashNextAmt.textContent = formatCurrency(nextPayment.amount);
                els.dashNextDate.textContent = `Due ${nextPayment.jsDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} (Ref ${nextPayment.ref})`;
            } else {
                els.dashNextAmt.textContent = "Done!"; els.dashNextDate.textContent = "-";
            }
        }

        function updateDetailView() {
            const dateStr = `${state.selectedDate.getFullYear()}-${String(state.selectedDate.getMonth() + 1).padStart(2, '0')}-${String(state.selectedDate.getDate()).padStart(2, '0')}`;
            const dayPayments = getFilteredPayments().filter(p => p.date === dateStr);
            const daySum = dayPayments.reduce((acc, curr) => acc + curr.amount, 0);
            els.detailTitle.textContent = state.selectedDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            els.detailTotal.textContent = formatCurrency(daySum);
            els.detailList.innerHTML = '';
            if (dayPayments.length === 0) {
                els.detailList.innerHTML = '<div class="text-sm text-slate-400 italic text-center py-6">Quiet day! No payments scheduled.</div>';
                els.detailContainer.classList.add('hidden');
            } else {
                els.detailContainer.classList.remove('hidden');
                dayPayments.forEach(p => {
                    const style = getStyle(p.ref);
                    const row = document.createElement('div');
                    row.className = `flex justify-between items-center p-4 rounded-2xl border ${style.bg} ${style.border} group hover:scale-[1.01] transition-transform`;
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="w-3 h-3 rounded-full ${style.dot} ring-4 ring-white shadow-sm"></span>
                            <span class="text-xs font-bold px-2 py-0.5 rounded-md bg-white/60 ${style.text}">Ref ${p.ref}</span>
                        </div>
                        <span class="font-bold text-slate-800">${formatCurrency(p.amount)}</span>
                    `;
                    els.detailList.appendChild(row);
                });
            }
        }

        function renderCalendar() {
            const year = state.currentYear, month = state.currentMonth;
            els.monthTitle.textContent = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });
            els.grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDate = new Date(year, month, 0);
            const activePayments = getFilteredPayments();
            const isMobile = window.innerWidth < 768;

            for (let week = 0; week < 6; week++) {
                let weeklyTotal = 0;
                for (let day = 0; day < 7; day++) {
                    const i = week * 7 + day;
                    let cYear = year, cMonth = month, cDay;
                    let isCur = true;
                    if (i < firstDay) { cDay = prevMonthDate.getDate() - (firstDay - i - 1); cMonth = month - 1; isCur = false; }
                    else if (i >= firstDay + daysInMonth) { cDay = i - (firstDay + daysInMonth) + 1; cMonth = month + 1; isCur = false; }
                    else { cDay = i - firstDay + 1; }
                    if (cMonth < 0) { cMonth = 11; cYear--; } else if (cMonth > 11) { cMonth = 0; cYear++; }
                    const dateObj = new Date(cYear, cMonth, cDay); dateObj.setHours(0,0,0,0);
                    const dateStr = `${cYear}-${String(cMonth + 1).padStart(2, '0')}-${String(cDay).padStart(2, '0')}`;
                    const isToday = dateObj.getTime() === todayActual.getTime();
                    const isSelected = state.selectedDate && dateObj.getTime() === state.selectedDate.getTime();
                    const dayPayments = activePayments.filter(p => p.date === dateStr);
                    const daySum = dayPayments.reduce((acc, curr) => acc + curr.amount, 0);
                    weeklyTotal += daySum;

                    const cell = document.createElement('div');
                    cell.className = `calendar-cell relative p-1 md:p-2 flex flex-col gap-1 border-r border-b border-slate-100 ${isCur ? 'bg-white' : 'bg-slate-50/40 text-slate-300'}`;
                    if (isSelected) cell.classList.add('selected-day');
                    cell.onclick = () => { state.selectedDate = dateObj; renderCalendar(); updateDetailView(); };

                    const hdr = document.createElement('div'); hdr.className = "flex justify-between items-start";
                    const num = document.createElement('span'); num.textContent = cDay;
                    num.className = isToday ? "today-marker w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-blue-600 text-white font-bold rounded-full text-xs md:text-sm shadow-lg shadow-blue-200" : "text-[11px] md:text-xs font-bold";
                    hdr.appendChild(num); cell.appendChild(hdr);

                    const body = document.createElement('div'); body.className = "flex-1 flex flex-col gap-1 mt-1";
                    if (isMobile) {
                        if (daySum > 0) {
                            const b = document.createElement('div'); b.className = `text-[9px] text-center font-bold py-1 rounded-lg border ${daySum > 1000 ? 'bg-orange-50 border-orange-100 text-orange-600' : 'bg-slate-100 border-slate-200 text-slate-600'}`;
                            b.textContent = formatCompact(daySum); body.appendChild(b);
                        }
                    } else {
                        dayPayments.slice(0, 3).forEach(p => {
                            const s = getStyle(p.ref);
                            const pill = document.createElement('div');
                            pill.className = `text-[9px] px-1.5 py-0.5 rounded-md border font-bold ${s.bg} ${s.border} ${s.text} shadow-sm`;
                            pill.textContent = formatCurrency(p.amount); body.appendChild(pill);
                        });
                        if (dayPayments.length > 3) {
                            const m = document.createElement('div'); m.className = "text-[8px] text-slate-400 font-bold ml-1";
                            m.textContent = `+${dayPayments.length - 3} more`; body.appendChild(m);
                        }
                    }
                    cell.appendChild(body); els.grid.appendChild(cell);
                }
                const led = document.createElement('div');
                led.className = "hidden md:flex flex-col items-center justify-center bg-emerald-50/20 border-b border-slate-100";
                if (weeklyTotal > 0) {
                    led.innerHTML = `<span class="text-[9px] text-emerald-400 font-bold uppercase tracking-tighter">Week Sum</span><span class="text-xs font-bold text-emerald-700 bg-white px-2 py-1 rounded-lg border border-emerald-100 shadow-sm">${formatCurrency(weeklyTotal)}</span>`;
                }
                els.grid.appendChild(led);
                if (weeklyTotal > 0 && isMobile) {
                    const r = document.createElement('div'); r.className = "col-span-7 bg-emerald-50/40 p-2 text-center border-b border-slate-200";
                    r.innerHTML = `<span class="text-[9px] font-bold text-emerald-600 uppercase tracking-widest">Weekly Total: ${formatCurrency(weeklyTotal)}</span>`;
                    els.grid.appendChild(r);
                }
            }
        }

        // --- Init ---
        document.getElementById('prev-month').onclick = () => { state.currentMonth--; if (state.currentMonth < 0) { state.currentMonth = 11; state.currentYear--; } updateDashboard(); renderCalendar(); };
        document.getElementById('next-month').onclick = () => { state.currentMonth++; if (state.currentMonth > 11) { state.currentMonth = 0; state.currentYear++; } updateDashboard(); renderCalendar(); };
        document.getElementById('jump-today').onclick = () => { state.currentYear = todayActual.getFullYear(); state.currentMonth = todayActual.getMonth(); state.selectedDate = todayActual; updateDashboard(); renderCalendar(); updateDetailView(); };
        window.onresize = renderCalendar;
        
        initFilters(); updateDashboard(); updateDetailView(); renderCalendar();
    </script>
</body>
</html>
